---
title: "Pathways Implementation Study"
author: "Jason Whittle"
date: "1/2/2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
knitr::opts_chunk$set(warning = F)
knitr::opts_chunk$set(message = F)
```

# Study Design

Two studies will be conducted:

4 years of first year business students prior to pathways will be used as the control group.

- This will compare business students to business students to eliminate major self-selection.
- I am not convinced that first term business majors are the same as a first year biology or sociology major.
- Year cannot be controlled for in this model since it would be collinear with the causal variable.
- This model will not use any additional matching but will make sure there arenâ€™t systematic differences in demographics or academic background.
        
        
One-year model of all students enrolled in Fall 2018.

- HARD FILTERS:

>> Excluded groups will be:

>> 1. CTE
2. SAT 
3. Students with GS declared major.
4. CSIS will be allowed despite being organized at a CTE program since it is in the Bus school

- PSM Model:

 >> 1. Former concurrent (possibility of breaking this variable down by CE courses taken)
 2. HS GPA factor
 3. Apt-test score factors
 4. eth *X* gen *X* age
 5. (census some college +/census pop) *X* census median income *X* (renters/pop)-1
 6. first generation

Outcomes for these models to measure:

>>  1. Fall-Spring Retention
        - (model 1: Bayesian logistic regression | model 2: MLM logistic regression)
    2. GPA (Fall term)
        - (model 1: BMA/Bayesian linear regression | model 2: MLM linear regression)
    3. Passing (Fall term)
    4. Term Credits (Fall term)

```{r}
library(readxl)
library(tidyverse); theme_set(theme_minimal())
```

```{r}
# old bus_data with Marie sql mistakes
# bus_data <- read_xlsx("IRR-768 2 Business Pathways Datasets.xlsx", sheet = "Business Pathway") # 4 year study
# new bus_data
bus_data <- read.csv("IRR_768_bus_data.csv")

# old gen_data with Marie sql mistakes
# gen_data <- read_xlsx("IRR-768 2 Business Pathways Datasets.xlsx", sheet = "non-general studies") # Fall 2018 comparison study
gen_data <- read.csv("IRR_768_gen_data.csv")
```

# Four year study

```{r}
# removing programs not used for pathways
bus_data <- bus_data %>% filter(PROGRAM_CODE != "CHEF-AAS" & PROGRAM_CODE != "CSIS-AS" & PROGRAM_CODE != "CSIS-AAS")

# fixing known data warehouse issues
bus_data$TOTAL_CREDITS_EARNED[is.na(bus_data$TOTAL_CREDITS_EARNED) == T] <- 0
bus_data$TERM_CREDITS[is.na(bus_data$TERM_CREDITS) == T] <- 0
bus_data$male <- ifelse(bus_data$GENDER_CODE == "M", 1, 0)
bus_data$FIRST_GENERATION_IND <- ifelse(bus_data$FIRST_GENERATION_IND == "Y", 1, 0)
bus_data$FALL_SPRING_RETENTION <- ifelse(bus_data$FALL_SPRING_RETENTION == "Y", 1, 0)
bus_data$FALL_SPRING_RETENTION[is.na(bus_data$FALL_SPRING_RETENTION) == T] <- 0
bus_data$EVER_CONCURRENT_IND <- ifelse(bus_data$EVER_CONCURRENT_IND == "Y", 1, 0)

bus_data$HIGH_SCHOOL_GPA <- ifelse(bus_data$HIGH_SCHOOL_GPA > 3, "AB",
                                ifelse(bus_data$HIGH_SCHOOL_GPA > 2, "BC", 
                                       ifelse(bus_data$HIGH_SCHOOL_GPA > 1, "CD", 
                                              ifelse(bus_data$HIGH_SCHOOL_GPA > 0, "DF", 
                                                     ifelse(is.na(bus_data$HIGH_SCHOOL_GPA) == T, "NA", "F")))))

# creating high risk ethnicity group dummy (Pacific Islander and Native American are known to retain at significantly lower levels than other groups)
bus_data$hr_rem <- ifelse(bus_data$ETHNICITY_CODE == "P" | bus_data$ETHNICITY_CODE == "I", 1, 0)

# imputing and adjusting problem data
## placement scores (max score is 120 so all values above this are incorrect)
bus_data$CPT_ARITHMEIC[bus_data$CPT_ARITHMEIC > 120] <- mean(bus_data$CPT_ARITHMEIC)
bus_data$CPT_COLLEGE_MATH[bus_data$CPT_COLLEGE_MATH > 120] <- mean(bus_data$CPT_COLLEGE_MATH)
bus_data$CPT_ELEM_ALGEBRA[bus_data$CPT_ELEM_ALGEBRA > 120] <- mean(bus_data$CPT_ELEM_ALGEBRA)
bus_data$CPT_READING[bus_data$CPT_READING > 120] <- mean(bus_data$CPT_READING)

## CB data
bus_data$CB_MEDIAN_INCOME[bus_data$CB_MEDIAN_INCOME < 0] <- mean(bus_data$CB_MEDIAN_INCOME)
bus_data$CB_MEDIAN_INCOME[is.na(bus_data$CB_MEDIAN_INCOME) == T] <- mean(bus_data$CB_MEDIAN_INCOME, na.rm = T)
bus_data$CB_ABOVE_SOME_COLLEGE[is.na(bus_data$CB_ABOVE_SOME_COLLEGE) == T] <- mean(bus_data$CB_ABOVE_SOME_COLLEGE, na.rm = T)
bus_data$CB_POPULATION[is.na(bus_data$CB_POPULATION) == T] <- mean(bus_data$CB_POPULATION, na.rm = T)
bus_data$CB_RENTER[is.na(bus_data$CB_RENTER) == T] <- mean(bus_data$CB_RENTER, na.rm = T)

# withdrew from all courses in a term
## will have to interact both of these terms
bus_data$wd <- ifelse(is.na(bus_data$TERM_GPA) == T, 1, 0)
bus_data$TERM_GPA[is.na(bus_data$TERM_GPA) == T] <- 0

# 201840 dummy for PSM
bus_data$treated <- ifelse(bus_data$TERM_CODE == 201840, 1, 0)

# summary(bus_data)
# names(bus_data)
```

### Plots for outcome variables

```{r}
# Term GPA
bus_data %>% ggplot() + 
  geom_density(aes(TERM_GPA, color = as.factor(TERM_CODE))) 
```

```{r}
# Term Credits
bus_data %>% ggplot() + 
  geom_density(aes(TERM_CREDITS, color = as.factor(TERM_CODE))) 
```

```{r}
# Passed fall semeseter
```

```{r}
# retained F-S semester
```

```{r}
library(lme4)
library(BMA)
library(MCMCpack)
```

```{r}
# term gpa outcome
# MCMCregress(TERM_GPA
#   data = bus_data)


# retention outcome



```


# Fall study

```{r}
# excluding some majors
gen_data <- gen_data %>% filter(PROGRAM_NAME != "Unknown" |
                                  PROGRAM_NAME != "General Studies - Undecide: PI" |
                                  PROGRAM_NAME != "General Studies: AA" |
                                  PROGRAM_NAME != "General Studies: AS" |
                                  PROGRAM_NAME != "General Studies: Transfer")

# fixing known data warehouse issues
gen_data$TOTAL_CREDITS_EARNED[is.na(gen_data$TOTAL_CREDITS_EARNED) == T] <- 0
gen_data$TERM_CREDITS[is.na(gen_data$TERM_CREDITS) == T] <- 0
gen_data$male <- ifelse(gen_data$GENDER_CODE == "M", 1, 0)
gen_data$FIRST_GENERATION_IND <- ifelse(gen_data$FIRST_GENERATION_IND == "Y", 1, 0)
gen_data$FALL_SPRING_RETENTION <- ifelse(gen_data$FALL_SPRING_RETENTION == "Y", 1, 0)
gen_data$FALL_SPRING_RETENTION[is.na(gen_data$FALL_SPRING_RETENTION) == T] <- 0
gen_data$EVER_CONCURRENT_IND <- ifelse(gen_data$EVER_CONCURRENT_IND == "Y", 1, 0)

# gen_data$HIGH_SCHOOL_GPA <- ifelse(gen_data$HIGH_SCHOOL_GPA > 3, "AB",
#                                 ifelse(gen_data$HIGH_SCHOOL_GPA > 2, "BC", 
#                                        ifelse(gen_data$HIGH_SCHOOL_GPA > 1, "CD", 
#                                               ifelse(gen_data$HIGH_SCHOOL_GPA > 0, "DF", 
#                                                      ifelse(is.na(gen_data$HIGH_SCHOOL_GPA) == T, "NO_GRADE", "F")))))
# gen_data$HIGH_SCHOOL_GPA[is.na(gen_data$HIGH_SCHOOL_GPA) == T] <- "NO_GRADE"

gen_data$HIGH_SCHOOL_GPA_AB <- ifelse(gen_data$HIGH_SCHOOL_GPA > 3, 1, 0)
gen_data$HIGH_SCHOOL_GPA_AB[is.na(gen_data$HIGH_SCHOOL_GPA_AB) == T] <- 0

gen_data$HIGH_SCHOOL_GPA_BC <- ifelse(gen_data$HIGH_SCHOOL_GPA > 2 & gen_data$HIGH_SCHOOL_GPA <= 3, 1, 0)
gen_data$HIGH_SCHOOL_GPA_BC[is.na(gen_data$HIGH_SCHOOL_GPA_BC) == T] <- 0

gen_data$HIGH_SCHOOL_GPA_CD <- ifelse(gen_data$HIGH_SCHOOL_GPA > 1 & gen_data$HIGH_SCHOOL_GPA <= 2, 1, 0)
gen_data$HIGH_SCHOOL_GPA_CD[is.na(gen_data$HIGH_SCHOOL_GPA_CD) == T] <- 0

gen_data$HIGH_SCHOOL_GPA_DF <- ifelse(gen_data$HIGH_SCHOOL_GPA > 0 & gen_data$HIGH_SCHOOL_GPA <= 1, 1, 0)
gen_data$HIGH_SCHOOL_GPA_DF[is.na(gen_data$HIGH_SCHOOL_GPA_DF) == T] <- 0

gen_data$HIGH_SCHOOL_GPA_NA <- ifelse(is.na(gen_data$HIGH_SCHOOL_GPA) == T, 1, 0)


# creating high risk ethnicity group dummy (Pacific Islander and Native American are known to retain at significantly lower levels than other groups)
gen_data$hr_rem <- ifelse(gen_data$ETHNICITY_CODE == "P" | gen_data$ETHNICITY_CODE == "I", 1, 0)

# imputing and adjusting problem data
## placement scores (max score is 120 so all values above this are incorrect)
gen_data$CPT_ARITHMEIC[gen_data$CPT_ARITHMEIC > 120] <- mean(gen_data$CPT_ARITHMEIC)
gen_data$CPT_COLLEGE_MATH[gen_data$CPT_COLLEGE_MATH > 120] <- mean(gen_data$CPT_COLLEGE_MATH)
gen_data$CPT_ELEM_ALGEBRA[gen_data$CPT_ELEM_ALGEBRA > 120] <- mean(gen_data$CPT_ELEM_ALGEBRA)
gen_data$CPT_READING[gen_data$CPT_READING > 120] <- mean(gen_data$CPT_READING)

## CB data
gen_data$CB_MEDIAN_INCOME[gen_data$CB_MEDIAN_INCOME < 0] <- mean(gen_data$CB_MEDIAN_INCOME)
gen_data$CB_MEDIAN_INCOME[is.na(gen_data$CB_MEDIAN_INCOME) == T] <- mean(gen_data$CB_MEDIAN_INCOME, na.rm = T)
gen_data$CB_ABOVE_SOME_COLLEGE[is.na(gen_data$CB_ABOVE_SOME_COLLEGE) == T] <- mean(gen_data$CB_ABOVE_SOME_COLLEGE, na.rm = T)
gen_data$CB_POPULATION[is.na(gen_data$CB_POPULATION) == T] <- mean(gen_data$CB_POPULATION, na.rm = T)
gen_data$CB_RENTER[is.na(gen_data$CB_RENTER) == T] <- mean(gen_data$CB_RENTER, na.rm = T)

# withdrew from all courses in a term
## will have to interact both of these terms
gen_data$wd <- ifelse(is.na(gen_data$TERM_GPA) == T, 1, 0)
gen_data$TERM_GPA[is.na(gen_data$TERM_GPA) == T] <- 0

# business program dummy variable
gen_data$bs_deg <- ifelse(gen_data$COLLEGE_CODE == "BU", 1, 0) # this will have CSIS major in it

# Removing BU programs that were not included in pathways from the treatment group indicator
gen_data$bs_deg[gen_data$COLLEGE_CODE == "BU"] <- 1
gen_data$bs_deg[is.na(gen_data$bs_deg) == T] <- 0
gen_data$bs_deg[gen_data$PROGRAM_NAME == "CIS/Comp Prog & Design: AAS" |
           gen_data$PROGRAM_NAME == "Computer Sci & Info Systems:AS" |
           gen_data$PROGRAM_NAME == "Computer Sci &Info Systems:AAS" |
           gen_data$PROGRAM_NAME == "Network Systems: AAS" |
           gen_data$PROGRAM_NAME == "Culinary Arts: AAS"] <- 0

# pulling out all other CTE programs, most BU programs are CTE and will not be pulled out
gen_data$cte <- ifelse(gen_data$CTE_IND == "Y", 1, 0) # all CTE programs
gen_data$cte_nobs <- gen_data$cte # CTE program that will exclude BU programs
gen_data$cte_nobs[gen_data$PROGRAM_NAME =="Hospitality Management: AAS" |
    gen_data$PROGRAM_NAME =="Finance & Credit: AAS" |
    gen_data$PROGRAM_NAME =="Marketing Management: AAS" |  
    gen_data$PROGRAM_NAME =="Culinary Arts: AAS" |
    gen_data$PROGRAM_NAME =="Business Administration: AAS" |
    gen_data$PROGRAM_NAME =="Paralegal Studies: AAS" |
    gen_data$PROGRAM_NAME =="Network Systems: AAS"] <- 0

# summary(gen_data)
```

### Raw outcome plots

```{r}
# Term GPA
gen_data %>%
  filter(cte_nobs == 0) %>%
  ggplot() + 
  geom_density(aes(TERM_GPA, color = as.factor(bs_deg))) 
```

```{r}
# Term GPA
gen_data %>% ggplot() + 
  geom_density(aes(TERM_CREDITS, color = as.factor(bs_deg))) 
```

### models



```{r}
gen_data_credit

lmer()

rm(gen_data_credit)
```

```{r}
gen_data_pass <- gen_data %>% 
  mutate(passed = TERM_GPA >= 2) %>%
  filter(cte_nobs == 0) %>%
  filter(wd == 0) %>%
  dplyr::select(passed,
                TERM_GPA,
                bs_deg,
                AGE_ON_FIRST_DAY,
                male, 
                hr_rem, 
                COLLEGE_READY_ENGLISH,
                COLLEGE_READY_MATH,
                TOTAL_CREDITS_EARNED,
                TERM_CREDITS,
                FIRST_GENERATION_IND, 
                EVER_CONCURRENT_IND,
                HIGH_SCHOOL_GPA_AB,
                HIGH_SCHOOL_GPA_BC,
                HIGH_SCHOOL_GPA_CD,
                HIGH_SCHOOL_GPA_DF)

gen_data_pass$AGE_ON_FIRST_DAY <- scale(gen_data_pass$AGE_ON_FIRST_DAY)
gen_data_pass$TOTAL_CREDITS_EARNED <- scale(gen_data_pass$TOTAL_CREDITS_EARNED)
gen_data_pass$TERM_CREDITS <- scale(gen_data_pass$TERM_CREDITS)
gen_data_pass$COLLEGE_READY_ENGLISH <- ifelse(gen_data_pass$COLLEGE_READY_ENGLISH == "Y", 1, 0)
gen_data_pass$COLLEGE_READY_MATH <- ifelse(gen_data_pass$COLLEGE_READY_MATH == "Y", 1,  0)

covar_all <- names(gen_data_pass)
covar <- covar_all[-c(1, 2, 3)]

fmla <- as.formula(bs_deg ~ 
                     AGE_ON_FIRST_DAY +
                     male + 
                     hr_rem + 
                     COLLEGE_READY_ENGLISH +
                     COLLEGE_READY_MATH +  
                     TOTAL_CREDITS_EARNED + 
                     TERM_CREDITS + 
                     FIRST_GENERATION_IND +
                     EVER_CONCURRENT_IND +
                     HIGH_SCHOOL_GPA_AB + 
                     HIGH_SCHOOL_GPA_BC +
                     HIGH_SCHOOL_GPA_CD + 
                     HIGH_SCHOOL_GPA_DF)

# STEP 1: select propensity score models with BMA
# Adapted from Cassie (Jianshen) Chen and David Kaplan 2014 r scrpit and paper
# "Bayesian Model Averaging for Propensity Score Analysis"
# BMA model selection
bma_bus <- bic.glm(fmla, data = gen_data_pass, glm.family = "binomial")

bma_bus$postprob # posterior predictive probability of each model
cumsum(bma_bus$postprob) # cumulative posterior predivtive probabilities
nmodel <- length(bma_bus$postprob) 
variables <- bma_bus$which # which variables were selected by models for BMA

# STEP 2: model top 5 with MCMClogit: Best  5  models (cumulative posterior probability =  0.8409)
set.seed(1983)
model <- rep(list(1), nmodel)
gmodel <- rep(list(1), nmodel)
bps_all <- rep(list(1), nmodel)
fmla_models <- rep(list(1, nmodel)) # object to hold all the models used for MCMClogit estimation

# for loop for running MCMC models based on BMA output
for (i in 1:nmodel)
{ 
  fmla <- as.formula(paste("bs_deg ~ ", paste(covar[variables[i,]==TRUE], collapse= "+")))
  fmla_models[[i]] <- as.formula(paste("bs_deg ~ ", paste(covar[variables[i,]==TRUE], collapse= "+")))
  model[[i]] <- MCMClogit(fmla, data=gen_data_pass, glm.family="binomial",mcmc=40000,thin=40,burnin=5000)
  gmodel[[i]] <- glm(fmla, data=gen_data_pass, family="binomial");
  beta=model[[i]]                #Posterior sample of the PS model parameters; length= #of iterations
  mat=model.matrix(gmodel[[i]])  #create a design matrix of covariates, length= # of students
  ps_BPSA1 <- matrix(rep(0,nrow(model[[i]])*nrow(gen_data_pass)),nrow=nrow(gen_data_pass))
  
  for(j in 1:nrow(beta)) # jth simulated set of beta => one set of ps
  {
    temp=mat%*%beta[j,]    
    ps_BPSA1[,j] <- exp(temp)/(1+exp(temp))
  }
  bps_all[[i]] <- ps_BPSA1 ## save the posterior distribution of ps for each of the selected models
}

# STEP 3: Sampling from all models posterior distributions from the BMA to obtain the weighted model posterior distribution

bma_ps2 <- matrix(rep(0,nrow(beta)*nrow(gen_data_pass)),nrow=nrow(gen_data_pass))
model_label <- 1:nmodel

# sample weigths 
post_prob <- bma_bus$postprob[1:nmodel]/sum(bma_bus$postprob[1:nmodel])

for (k in 1:nrow(beta))
{
  bma_ps2[,k] <- bps_all[[sample(model_label,1,prob=post_prob)]][,k]
}

# STEP 4: match based on model from STEP 3

#### Optimal Matching
# used Matching instead of optmatch library
library(Matching)

Y <- gen_data_pass$passed
Tr <- gen_data_pass$bs_deg


optm1=cbind(rep(0,nrow(beta)),rep(0,nrow(beta)))
for(i in 1:nrow(beta))
{
  test=Match(Y=Y, Tr=Tr, X=bma_ps2[,i], ties=F)
  optm1[i,] <- c(test$est, test$se)
}

# STEP 5: estimate the treatment effect

# pathways passing evaluation



```

```{r}
gen_data_ret

lmer()

rm(gen_data_ret)
```

