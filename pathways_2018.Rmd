---
title: "Pathways Implementation Study"
author: "Jason Whittle"
date: "1/2/2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
knitr::opts_chunk$set(warning = F)
knitr::opts_chunk$set(message = F)
knitr::opts_chunk$set(eval = F)
knitr::opts_chunk$set(include = F)
```

```{r, eval=TRUE,  include=TRUE}
library(lme4)
library(BMA)
library(MCMCpack)
```

# Study Design

Two studies will be conducted:

4 years of first year business students prior to pathways will be used as the control group.

- This will compare business students to business students to eliminate major self-selection.
- I am not convinced that first term business majors are the same as a first year biology or sociology major.
- Year cannot be controlled for in this model since it would be collinear with the causal variable.
- This model will not use any additional matching but will make sure there arenâ€™t systematic differences in demographics or academic background.
        
        
One-year model of all students enrolled in Fall 2018.

- HARD FILTERS:

>> Excluded groups will be:

>> 1. CTE
2. SAT 
3. Students with GS declared major.
4. CSIS will be allowed despite being organized at a CTE program since it is in the Bus school

- PSM Model:

 >> 1. Former concurrent (possibility of breaking this variable down by CE courses taken)
 2. HS GPA factor
 3. Apt-test score factors
 4. eth *X* gen *X* age
 5. (census some college +/census pop) *X* census median income *X* (renters/pop)-1
 6. first generation

Outcomes for these models to measure:

>>  1. Fall-Spring Retention
        - (model 1: Bayesian logistic regression | model 2: MLM logistic regression)
    2. GPA (Fall term)
        - (model 1: BMA/Bayesian linear regression | model 2: MLM linear regression)
    3. Passing (Fall term)
    4. Term Credits (Fall term)


<!-- ## Pathways pilot deliverable data items promised -->

<!-- Metrics & Analysis:  -->
<!-- Descriptive stats on:  -->
<!-- - Number of students contacted? -->
<!-- - How many were contacted then changed majors? -->
<!-- -	Did they actually attend 4 hours orientation?  -->
<!-- -	Did they have a 1st advisor meeting? -->
<!-- -	Did they register? -->
<!-- -	Did they choose from the "safe list" of courses? -->

<!-- Comparison against a control group:  -->
<!-- -	Orientation type? -->
<!-- -	Speed to registration after orientation?  -->
<!-- -	Number of credit hours?  -->
<!-- -	Program of study (what they declared in their application vs. dim_student_term)? -->

```{r, eval=TRUE,  include=TRUE}
library(readxl)
library(tidyverse); theme_set(theme_minimal())
```

```{r, eval=TRUE,  include=TRUE}
# old bus_data with Marie sql mistakes
# bus_data <- read_xlsx("IRR-768 2 Business Pathways Datasets.xlsx", sheet = "Business Pathway") # 4 year study
# new bus_data
# bus_data <- read.csv("IRR_768_bus_data.csv") %>% dplyr::select(-FIRST_NAME, -LAST_NAME, -BIRTH_DATE)
# bus_data <- read.csv("IRR_768_bus_data_2.csv") %>% dplyr::select(-FIRST_NAME, -LAST_NAME, -BIRTH_DATE, -ETHNICITY, -GENDER)
bus_data <- read.csv("IRR_768_bus_data_3.csv") %>% dplyr::select(-FIRST_NAME, -LAST_NAME, -BIRTH_DATE, -ETHNICITY, -GENDER) # adds gateway momentum and program momentum indicators

# old gen_data with Marie sql mistakes
# gen_data <- read_xlsx("IRR-768 2 Business Pathways Datasets.xlsx", sheet = "non-general studies") # Fall 2018 comparison study
# gen_data <- read.csv("IRR_768_gen_data.csv")
gen_data <- read.csv("IRR_768_gen_data_2.csv") %>% dplyr::select(-FIRST_NAME, -LAST_NAME, -BIRTH_DATE, -ETHNICITY, -GENDER)
```

# Four year BUS study

```{r, eval=TRUE,  include=TRUE}
# removing programs not used for pathways
bus_data <- bus_data %>% filter(PROGRAM_CODE != "CHEF-AAS" & PROGRAM_CODE != "CSIS-AS" & PROGRAM_CODE != "CSIS-AAS")

# fixing known data warehouse issues
bus_data$TOTAL_CREDITS_EARNED[is.na(bus_data$TOTAL_CREDITS_EARNED) == T] <- 0
bus_data$TERM_CREDITS[is.na(bus_data$TERM_CREDITS) == T] <- 0
bus_data$male <- ifelse(bus_data$GENDER_CODE == "M", 1, 0)
bus_data$FIRST_GENERATION_IND <- ifelse(bus_data$FIRST_GENERATION_IND == "Y", 1, 0)
bus_data$FALL_SPRING_RETENTION <- ifelse(bus_data$FALL_SPRING_RETENTION == "Y", 1, 0)
bus_data$FALL_SPRING_RETENTION[is.na(bus_data$FALL_SPRING_RETENTION) == T] <- 0
bus_data$EVER_CONCURRENT_IND <- ifelse(bus_data$EVER_CONCURRENT_IND == "Y", 1, 0)

bus_data$hs_gpa <- bus_data$HIGH_SCHOOL_GPA

bus_data$HIGH_SCHOOL_GPA <- ifelse(bus_data$HIGH_SCHOOL_GPA > 3, "AB",
                                ifelse(bus_data$HIGH_SCHOOL_GPA > 2, "BC", 
                                       ifelse(bus_data$HIGH_SCHOOL_GPA > 1, "CD", 
                                              ifelse(bus_data$HIGH_SCHOOL_GPA > 0, "DF", 
                                                     ifelse(is.na(bus_data$HIGH_SCHOOL_GPA) == T, "NA", "F")))))

# creating high risk ethnicity group dummy (Pacific Islander and Native American are known to retain at significantly lower levels than other groups)
bus_data$hr_rem <- ifelse(bus_data$ETHNICITY_CODE == "P" | bus_data$ETHNICITY_CODE == "I", 1, 0)

# imputing and adjusting problem data
## placement scores (max score is 120 so all values above this are incorrect)
#### There was a placement experiment that used 998 as a values so >120 are not incorrect
# bus_data$CPT_ARITHMEIC[bus_data$CPT_ARITHMEIC > 120] <- mean(bus_data$CPT_ARITHMEIC)
# bus_data$CPT_COLLEGE_MATH[bus_data$CPT_COLLEGE_MATH > 120] <- mean(bus_data$CPT_COLLEGE_MATH)
# bus_data$CPT_ELEM_ALGEBRA[bus_data$CPT_ELEM_ALGEBRA > 120] <- mean(bus_data$CPT_ELEM_ALGEBRA)
# bus_data$CPT_READING[bus_data$CPT_READING > 120] <- mean(bus_data$CPT_READING)

bus_data$math_place <- ifelse(bus_data$CPT_COLLEGE_MATH > 120, 1, 0)
bus_data$math_place[is.na(bus_data$math_place) == T] <- 0


## CB data
bus_data$CB_MEDIAN_INCOME[bus_data$CB_MEDIAN_INCOME < 0] <- mean(bus_data$CB_MEDIAN_INCOME)
bus_data$CB_MEDIAN_INCOME[is.na(bus_data$CB_MEDIAN_INCOME) == T] <- mean(bus_data$CB_MEDIAN_INCOME, na.rm = T)
bus_data$CB_ABOVE_SOME_COLLEGE[is.na(bus_data$CB_ABOVE_SOME_COLLEGE) == T] <- mean(bus_data$CB_ABOVE_SOME_COLLEGE, na.rm = T)
bus_data$CB_POPULATION[is.na(bus_data$CB_POPULATION) == T] <- mean(bus_data$CB_POPULATION, na.rm = T)
bus_data$CB_RENTER[is.na(bus_data$CB_RENTER) == T] <- mean(bus_data$CB_RENTER, na.rm = T)
bus_data$CB_PCT_COL <- bus_data$CB_ABOVE_SOME_COLLEGE/bus_data$CB_POPULATION
bus_data$CB_PCT_COL[is.na(bus_data$CB_PCT_COL) == T] <- 0

# withdrew from all courses in a term
## will have to interact both of these terms
bus_data$wd <- ifelse(is.na(bus_data$TERM_GPA) == T, 1, 0)
bus_data$TERM_GPA[is.na(bus_data$TERM_GPA) == T] <- 0

# 201840 dummy for PSM
bus_data$treated <- ifelse(bus_data$TERM_CODE == 201840, 1, 0)

# summary(bus_data)
# names(bus_data)

bus_data$credits_mo <- ifelse(bus_data$TERM_CREDITS >= 15, 1, 0) # credit momentum
bus_data$passing <- ifelse(bus_data$TERM_GPA >=2, 1, 0)
bus_data$male_age <- bus_data$male*bus_data$AGE_ON_FIRST_DAY
bus_data$col_first_gen <- bus_data$CB_PCT_COL*bus_data$FIRST_GENERATION_IND

bus_data$BUS_CREDITS[is.na(bus_data$BUS_CREDITS) == T] <- 0
```

## BUS student models
```{r, eval=TRUE,  include=TRUE}
# BUS only model
bus_mo_bma <- as.formula(credits_mo ~ 
                     scale(AGE_ON_FIRST_DAY) +
                     male + 
                     male_age +
                     hr_rem + 
                     COLLEGE_READY_ENGLISH +
                     COLLEGE_READY_MATH +   
                     FIRST_GENERATION_IND +
                     EVER_CONCURRENT_IND +
                     CB_PCT_COL + 
                     scale(CB_MEDIAN_INCOME) + 
                     col_first_gen +
                     treated)
# bus_data credit momentum
# bus_mo_model_bma <- bic.glm(bus_mo_bma, data = bus_data, glm.family = "binomial", occam.window = F)
# summary(bus_mo_model_bma)
#bus_mo_bma_plot <- plot(bus_mo_model_bma)


bus_mo_model <- MCMClogit(bus_mo_bma, data = bus_data, glm.family="binomial",mcmc=40000,thin=40,burnin=5000)
bus_mo_sum <- summary(bus_mo_model)
plot(bus_mo_model[,13], density = TRUE, trace = FALSE, main = "Pathways Estimated Treatment Effect on Credit Momentum", xlab = "") # checked

df_mo <- as.data.frame(bus_mo_model[,13])
bus_crd_mo <- df_mo %>%
  ggplot() + 
  geom_histogram(aes(var1)) + 
  labs(title ="Pathways Estimated Treatment Effect on Credit Momentum", x = "" ) + 
  geom_vline(xintercept = 0) + 
  geom_vline(xintercept = bus_mo_sum$quantiles[13,1], linetype = "dashed") + 
  geom_vline(xintercept = bus_mo_sum$quantiles[13,5], linetype = "dashed")
  
# bus_mo_sum
# bus_crd_mo # checked
```

```{r, eval=TRUE,  include=TRUE}
# bus_data term credits
bus_tc_bma <- as.formula(scale(TERM_CREDITS) ~ 
                     scale(AGE_ON_FIRST_DAY) +
                     male + 
                     male_age +
                     hr_rem + 
                     COLLEGE_READY_ENGLISH +
                     COLLEGE_READY_MATH +   
                     FIRST_GENERATION_IND +
                     EVER_CONCURRENT_IND +
                     CB_PCT_COL + 
                     scale(CB_MEDIAN_INCOME) + 
                     col_first_gen +
                     treated)

bus_tc_model_mcmc <- MCMCregress(bus_tc_bma, data = bus_data, mcmc=40000,thin=40,burnin=5000)
bus_tc_sum <- summary(bus_tc_model_mcmc)
plot(bus_tc_model_mcmc[,13], density = TRUE, trace = FALSE, main = "Pathways Estimated Treatment Effect on Fall Term Credits", xlab = "") # checked

df_tc <- as.data.frame(bus_tc_model_mcmc[,13])
bus_term_crd <- df_tc %>%
  ggplot() + 
  geom_histogram(aes(var1)) + 
  labs(title ="Pathways Estimated Treatment Effect on Fall Term Credits", x = "" ) + 
  geom_vline(xintercept = 0) + 
  geom_vline(xintercept = bus_tc_sum$quantiles[13,1], linetype = "dashed") + 
  geom_vline(xintercept = bus_tc_sum$quantiles[13,5], linetype = "dashed")

# bus_tc_sum
# bus_term_crd #checked
```

```{r, eval=TRUE,  include=TRUE}
# bus_data passing
bus_passing <- as.formula(passing ~
                            scale(AGE_ON_FIRST_DAY) +
                            male + 
                            male_age +
                            hr_rem + 
                            COLLEGE_READY_ENGLISH +
                            COLLEGE_READY_MATH +  
                            FIRST_GENERATION_IND +
                            EVER_CONCURRENT_IND +
                            CB_PCT_COL + 
                            scale(CB_MEDIAN_INCOME) +
                            col_first_gen +
                            TERM_CREDITS + 
                            treated
  
)

bus_pass_model <- MCMClogit(bus_passing, data = bus_data, glm.family="binomial",mcmc=40000,thin=40,burnin=5000)
bus_pass_sum <- summary(bus_pass_model)
plot(bus_pass_model[,14], density = TRUE, trace = FALSE, main = "Pathways Estimated Treatment Effect on Passing GPA", xlab = "") # checked

df_pass <- as.data.frame(bus_pass_model[,14])
bus_passing_gpa <- df_pass %>%
  ggplot() + 
  geom_histogram(aes(var1)) + 
  labs(title ="Pathways Estimated Treatment Effect on Passing GPA", x = "" ) + 
  geom_vline(xintercept = 0) + 
  geom_vline(xintercept = bus_pass_sum$quantiles[14,1], linetype = "dashed") + 
  geom_vline(xintercept = bus_pass_sum$quantiles[14,5], linetype = "dashed")

# bus_pass_sum
# bus_passing_gpa #checked
```

```{r, eval=TRUE,  include=TRUE}
# bus_data F-S retention
bus_reten <- as.formula(FALL_SPRING_RETENTION ~
                            scale(AGE_ON_FIRST_DAY) +
                            male + 
                            male_age +
                            hr_rem + 
                            COLLEGE_READY_ENGLISH +
                            COLLEGE_READY_MATH +  
                            FIRST_GENERATION_IND +
                            EVER_CONCURRENT_IND +
                            CB_PCT_COL + 
                            scale(CB_MEDIAN_INCOME) +
                            col_first_gen +
                            TERM_CREDITS + 
                            treated 
  
)

bus_ret_model <- MCMCregress(bus_reten, data = bus_data, glm.family="binomial",mcmc=40000,thin=40,burnin=5000)
bus_ret_sum <- summary(bus_ret_model)
plot(bus_ret_model[,14], density = TRUE, trace = FALSE, main = "Pathways Estimated Treatment Effect on F-S Retention", xlab = "") # checked

df_ret <- as.data.frame(bus_ret_model[,14])
bus_fs_ret <- df_ret %>%
  ggplot() + 
  geom_histogram(aes(var1)) + 
  labs(title ="Pathways Estimated Treatment Effect on F-S Retention", x = "" ) + 
  geom_vline(xintercept = 0) + 
  geom_vline(xintercept = bus_ret_sum$quantiles[14,1], linetype = "dashed") + 
  geom_vline(xintercept = bus_ret_sum$quantiles[14,5], linetype = "dashed")

# bus_ret_sum
# bus_fs_ret # checked

```

```{r, eval=TRUE,  include=TRUE}
# gateway momentum 
# ENGL_1010_2010_ENROLLMENTS
bus_gate_mcmc_el <- as.formula(ENGL_1010_2010_ENROLLMENTS ~ 
                     scale(AGE_ON_FIRST_DAY) +
                     male + 
                     male_age +
                     hr_rem + 
                     COLLEGE_READY_ENGLISH +
                     COLLEGE_READY_MATH +   
                     FIRST_GENERATION_IND +
                     EVER_CONCURRENT_IND +
                     CB_PCT_COL + 
                     scale(CB_MEDIAN_INCOME) + 
                     col_first_gen +
                     treated)

bus_gate_model_el <- MCMClogit(bus_gate_mcmc_el, data = bus_data, glm.family="binomial",mcmc=40000,thin=40,burnin=5000)
bus_engl_model_sum <- summary(bus_gate_model_el)
plot(bus_gate_model_el[,13], density = TRUE, trace = FALSE, main = "Pathways Estimated Treatment Effect on ENGL gateway Momentum", xlab = "") # checked

df_engl <- as.data.frame(bus_gate_model_el[,13])
bus_engl_mo <- df_engl %>%
  ggplot() + 
  geom_histogram(aes(var1)) + 
  labs(title ="Pathways Estimated Treatment Effect on ENGL gateway Momentum", x = "" ) + 
  geom_vline(xintercept = 0)+ 
  geom_vline(xintercept = bus_engl_model_sum$quantiles[13,1], linetype = "dashed") + 
  geom_vline(xintercept = bus_engl_model_sum$quantiles[13,5], linetype = "dashed")

# bus_engl_model_sum
# bus_engl_mo # checked
```

```{r, eval=TRUE,  include=TRUE}
# QL_ENROLLMENTS
bus_ql_mcmc <- as.formula(QL_ENROLLMENTS ~ 
                     scale(AGE_ON_FIRST_DAY) +
                     male + 
                     male_age +
                     hr_rem + 
                     COLLEGE_READY_ENGLISH +
                     COLLEGE_READY_MATH +   
                     FIRST_GENERATION_IND +
                     EVER_CONCURRENT_IND +
                     CB_PCT_COL + 
                     scale(CB_MEDIAN_INCOME) + 
                     col_first_gen +
                     math_place + 
                     treated)

bus_ql_model <- MCMClogit(bus_ql_mcmc, data = bus_data, glm.family="binomial",mcmc=40000,thin=40,burnin=5000)
bus_ql_model_sum <- summary(bus_ql_model)
plot(bus_ql_model[,14], density = TRUE, trace = FALSE, main = "Pathways Estimated Treatment Effect on QL gateway Momentum", xlab = "") # checked (actual affect is probably from self-guided placement)

summary(bus_ql_model)

exp(0.1742)/(1 + (exp(0.1742)))
exp(1.5219)/(1 + (exp(1.5219)))

mean(exp(bus_ql_model[,14])/(1 + (exp(bus_ql_model[,14]))))

df_ql <- as.data.frame(bus_ql_model[,14])
bus_ql_mo <- df_ql %>%
  ggplot() + 
  geom_density(aes(var1)) + 
  labs(title ="Pathways Estimated Treatment Effect on QL gateway Momentum", x = "" ) + 
  geom_vline(xintercept = 0) + 
  geom_vline(xintercept = bus_ql_model_sum$quantiles[14,1], linetype = "dashed") + 
  geom_vline(xintercept = bus_ql_model_sum$quantiles[14,5], linetype = "dashed")

# bus_ql_model_sum
# bus_ql_mo # checked
```

```{r, eval=TRUE,  include=TRUE}
# Program gateway
# BUS_CREDITS
bus_gate_mcmc <- as.formula(BUS_CREDITS ~ 
                     scale(AGE_ON_FIRST_DAY) +
                     male + 
                     male_age +
                     hr_rem + 
                     COLLEGE_READY_ENGLISH +
                     COLLEGE_READY_MATH +   
                     FIRST_GENERATION_IND +
                     EVER_CONCURRENT_IND +
                     CB_PCT_COL + 
                     scale(CB_MEDIAN_INCOME) + 
                     col_first_gen +
                     treated)

bus_gate_model <- MCMCregress(bus_gate_mcmc, data = bus_data, mcmc=40000,thin=40,burnin=5000)
bus_gate_model_sum <- summary(bus_gate_model)
plot(bus_gate_model[,13], density = TRUE, trace = FALSE, main = "Pathways Estimated Treatment Effect on Program Momentum", xlab = "") # checked


df_pro_gate <- as.data.frame(bus_gate_model[,13])
bus_prog_mo <- df_pro_gate %>%
  ggplot() + 
  geom_density(aes(var1)) + 
  labs(title ="Pathways Estimated Treatment Effect on Program Momentum",
       x = "", 
       y = "Relative Estimate Density") + 
  geom_vline(xintercept = 0) + 
  geom_vline(xintercept = bus_gate_model_sum$quantiles[13,1], linetype = "dashed") + 
  geom_vline(xintercept = bus_gate_model_sum$quantiles[13,5], linetype = "dashed") # this is close to seeming like a negative impact. On edge of 95%

# bus_gate_model_sum
# bus_prog_mo # checked

```



# Fall first time student study

```{r, eval=TRUE,  include=TRUE}
# excluding some majors
gen_data <- gen_data %>% filter(PROGRAM_NAME != "Unknown" |
                                  PROGRAM_NAME != "General Studies - Undecide: PI" |
                                  PROGRAM_NAME != "General Studies: AA" |
                                  PROGRAM_NAME != "General Studies: AS" |
                                  PROGRAM_NAME != "General Studies: Transfer")

# fixing known data warehouse issues
gen_data$TOTAL_CREDITS_EARNED[is.na(gen_data$TOTAL_CREDITS_EARNED) == T] <- 0
gen_data$TERM_CREDITS[is.na(gen_data$TERM_CREDITS) == T] <- 0
gen_data$male <- ifelse(gen_data$GENDER_CODE == "M", 1, 0)
gen_data$FIRST_GENERATION_IND <- ifelse(gen_data$FIRST_GENERATION_IND == "Y", 1, 0)
gen_data$FALL_SPRING_RETENTION <- ifelse(gen_data$FALL_SPRING_RETENTION == "Y", 1, 0)
gen_data$FALL_SPRING_RETENTION[is.na(gen_data$FALL_SPRING_RETENTION) == T] <- 0
gen_data$EVER_CONCURRENT_IND <- ifelse(gen_data$EVER_CONCURRENT_IND == "Y", 1, 0)

# HIGH_SCHOOL_GPA factor variable
gen_data$HIGH_SCHOOL_GPA_AB <- ifelse(gen_data$HIGH_SCHOOL_GPA > 3, 1, 0)
gen_data$HIGH_SCHOOL_GPA_AB[is.na(gen_data$HIGH_SCHOOL_GPA_AB) == T] <- 0

gen_data$HIGH_SCHOOL_GPA_BC <- ifelse(gen_data$HIGH_SCHOOL_GPA > 2 & gen_data$HIGH_SCHOOL_GPA <= 3, 1, 0)
gen_data$HIGH_SCHOOL_GPA_BC[is.na(gen_data$HIGH_SCHOOL_GPA_BC) == T] <- 0

gen_data$HIGH_SCHOOL_GPA_CD <- ifelse(gen_data$HIGH_SCHOOL_GPA > 1 & gen_data$HIGH_SCHOOL_GPA <= 2, 1, 0)
gen_data$HIGH_SCHOOL_GPA_CD[is.na(gen_data$HIGH_SCHOOL_GPA_CD) == T] <- 0

gen_data$HIGH_SCHOOL_GPA_DF <- ifelse(gen_data$HIGH_SCHOOL_GPA > 0 & gen_data$HIGH_SCHOOL_GPA <= 1, 1, 0)
gen_data$HIGH_SCHOOL_GPA_DF[is.na(gen_data$HIGH_SCHOOL_GPA_DF) == T] <- 0

gen_data$HIGH_SCHOOL_GPA_NA <- ifelse(is.na(gen_data$HIGH_SCHOOL_GPA) == T, 1, 0)

# creating high risk ethnicity group dummy (Pacific Islander and Native American are known to retain at significantly lower levels than other groups)
gen_data$hr_rem <- ifelse(gen_data$ETHNICITY_CODE == "P" | gen_data$ETHNICITY_CODE == "I", 1, 0)

# imputing and adjusting problem data
## placement scores (max score is 120 so all values above this are incorrect)
gen_data$CPT_ARITHMEIC[gen_data$CPT_ARITHMEIC > 120] <- mean(gen_data$CPT_ARITHMEIC)
gen_data$CPT_COLLEGE_MATH[gen_data$CPT_COLLEGE_MATH > 120] <- mean(gen_data$CPT_COLLEGE_MATH)
gen_data$CPT_ELEM_ALGEBRA[gen_data$CPT_ELEM_ALGEBRA > 120] <- mean(gen_data$CPT_ELEM_ALGEBRA)
gen_data$CPT_READING[gen_data$CPT_READING > 120] <- mean(gen_data$CPT_READING)

## CB data
gen_data$CB_MEDIAN_INCOME[gen_data$CB_MEDIAN_INCOME < 0] <- mean(gen_data$CB_MEDIAN_INCOME)
gen_data$CB_MEDIAN_INCOME[is.na(gen_data$CB_MEDIAN_INCOME) == T] <- mean(gen_data$CB_MEDIAN_INCOME, na.rm = T)
gen_data$CB_ABOVE_SOME_COLLEGE[is.na(gen_data$CB_ABOVE_SOME_COLLEGE) == T] <- mean(gen_data$CB_ABOVE_SOME_COLLEGE, na.rm = T)
gen_data$CB_POPULATION[is.na(gen_data$CB_POPULATION) == T] <- mean(gen_data$CB_POPULATION, na.rm = T)
gen_data$CB_RENTER[is.na(gen_data$CB_RENTER) == T] <- mean(gen_data$CB_RENTER, na.rm = T)
gen_data$CB_PCT_COL <- gen_data$CB_ABOVE_SOME_COLLEGE/gen_data$CB_POPULATION

# withdrew from all courses in a term
## will have to interact both of these terms
gen_data$wd <- ifelse(is.na(gen_data$TERM_GPA) == T, 1, 0)
gen_data$TERM_GPA[is.na(gen_data$TERM_GPA) == T] <- 0

# business program dummy variable
gen_data$bus_deg <- ifelse(gen_data$COLLEGE_CODE == "BU", 1, 0) # this will have CSIS major in it

# Removing BU programs that were not included in pathways from the treatment group indicator
gen_data$bus_deg[gen_data$COLLEGE_CODE == "BU"] <- 1
gen_data$bus_deg[is.na(gen_data$bs_deg) == T] <- 0
gen_data$bus_deg[gen_data$PROGRAM_NAME == "CIS/Comp Prog & Design: AAS" |
           gen_data$PROGRAM_NAME == "Computer Sci & Info Systems:AS" |
           gen_data$PROGRAM_NAME == "Computer Sci &Info Systems:AAS" |
           gen_data$PROGRAM_NAME == "Network Systems: AAS" |
           gen_data$PROGRAM_NAME == "Culinary Arts: AAS"] <- 0

# pulling out all other CTE programs, most BU programs are CTE and will not be pulled out
gen_data$cte <- ifelse(gen_data$CTE_IND == "Y", 1, 0) # all CTE programs
gen_data$cte_nobs <- gen_data$cte # CTE program that will exclude BU programs
gen_data$cte_nobs[gen_data$PROGRAM_NAME =="Hospitality Management: AAS" |
    gen_data$PROGRAM_NAME =="Finance & Credit: AAS" |
    gen_data$PROGRAM_NAME =="Marketing Management: AAS" |  
    gen_data$PROGRAM_NAME =="Culinary Arts: AAS" |
    gen_data$PROGRAM_NAME =="Business Administration: AAS" |
    gen_data$PROGRAM_NAME =="Paralegal Studies: AAS" |
    gen_data$PROGRAM_NAME =="Network Systems: AAS"] <- 0

# change bs_deg to the exact student who met with advisor. 
pathways <- read.csv("bus_path_data_warehouse.csv")
pathways <- cbind(pathways, 1)
names(pathways) <- c("PIDM", "GROUP", "PATHWAYS") # 229 pathways students

gen_data <- gen_data %>% left_join(pathways[,c(1,3)], by = "PIDM") # 209 pathways students joined to gen_data

gen_data$bs_deg <- gen_data$PATHWAYS
gen_data$bs_deg[is.na(gen_data$bs_deg) == T] <- 0

# momentum credit mark
gen_data$credits_mo <- ifelse(gen_data$TERM_CREDITS >= 15, 1, 0)
```

## Models

### Term GPA, Passing Rate, Retention models

```{r, eval=TRUE,  include=TRUE}
gen_data_pass <- gen_data %>% 
  mutate(passed = TERM_GPA >= 2) %>%
  filter(cte_nobs == 0) %>%
  filter(wd == 0) %>%
  dplyr::select(passed,
                TERM_GPA,
                FALL_SPRING_RETENTION,
                bs_deg,
                TERM_CREDITS,
                AGE_ON_FIRST_DAY,
                male, 
                hr_rem, 
                COLLEGE_READY_ENGLISH,
                COLLEGE_READY_MATH,
                TOTAL_CREDITS_EARNED,
                FIRST_GENERATION_IND, 
                EVER_CONCURRENT_IND,
                HIGH_SCHOOL_GPA_AB,
                HIGH_SCHOOL_GPA_BC,
                HIGH_SCHOOL_GPA_CD,
                HIGH_SCHOOL_GPA_DF,
                CB_PCT_COL,
                CB_MEDIAN_INCOME)

gen_data_pass$AGE_ON_FIRST_DAY <- scale(gen_data_pass$AGE_ON_FIRST_DAY)
gen_data_pass$TOTAL_CREDITS_EARNED <- scale(gen_data_pass$TOTAL_CREDITS_EARNED)
gen_data_pass$TERM_CREDITS <- scale(gen_data_pass$TERM_CREDITS)
gen_data_pass$COLLEGE_READY_ENGLISH <- ifelse(gen_data_pass$COLLEGE_READY_ENGLISH == "Y", 1, 0)
gen_data_pass$COLLEGE_READY_MATH <- ifelse(gen_data_pass$COLLEGE_READY_MATH == "Y", 1,  0)
gen_data_pass$CB_MEDIAN_INCOME <- scale(gen_data_pass$CB_MEDIAN_INCOME)
gen_data_pass$male_age <- gen_data_pass$male*gen_data_pass$AGE_ON_FIRST_DAY # interaction variable for age and gender
gen_data_pass$col_first_gen <- gen_data_pass$CB_PCT_COL*gen_data_pass$FIRST_GENERATION_IND # interaction variable for CB percent college and first gen

covar_all <- names(gen_data_pass)
covar <- covar_all[-c(1, 2, 3, 4)] # Term credits should be left in for Passes, TERM_GPA and Retention modeling but should be removed from term_credit modeling obviously

fmla_bma <- as.formula(bs_deg ~ TERM_CREDITS +
                     AGE_ON_FIRST_DAY +
                     male + 
                     male_age +
                     hr_rem + 
                     COLLEGE_READY_ENGLISH +
                     COLLEGE_READY_MATH +  
                     TOTAL_CREDITS_EARNED + 
                     FIRST_GENERATION_IND +
                     EVER_CONCURRENT_IND +
                     HIGH_SCHOOL_GPA_AB + 
                     HIGH_SCHOOL_GPA_BC +
                     HIGH_SCHOOL_GPA_CD + 
                     HIGH_SCHOOL_GPA_DF + 
                     CB_PCT_COL + 
                     CB_MEDIAN_INCOME + 
                     col_first_gen)
```

```{r, eval=TRUE,  include=TRUE}
# STEP 1: select propensity score models with BMA
# Adapted from Cassie (Jianshen) Chen and David Kaplan 2014 r scrpit and paper
# "Bayesian Model Averaging for Propensity Score Analysis"
# BMA model selection
bma_bus <- bic.glm(fmla_bma, data = gen_data_pass, glm.family = "binomial", occam.window = F)

summary(bma_bus)
# imageplot.bma(bma_bus)
```

```{r, eval=TRUE,  include=TRUE}
bma_bus$postprob # posterior predictive probability of each model
cumsum(bma_bus$postprob) # cumulative posterior predivtive probabilities
nmodel <- length(bma_bus$postprob) 
variables <- bma_bus$which # which variables were selected by models for BMA

# STEP 2: all BMA models with MCMClogit: Best  5  models (cumulative posterior probability =  0.6181)
set.seed(1983)
model <- rep(list(1), nmodel)
gmodel <- rep(list(1), nmodel)
bps_all <- rep(list(1), nmodel)
fmla_models <- rep(list(1, nmodel)) # object to hold all the models used for MCMClogit estimation

# for loop for running MCMC models based on BMA output
for (i in 1:nmodel)
{ 
  fmla <- as.formula(paste("bs_deg ~ ", paste(covar[variables[i,]==TRUE], collapse= "+")))
  fmla_models[[i]] <- as.formula(paste("bs_deg ~ ", paste(covar[variables[i,]==TRUE], collapse= "+")))
  model[[i]] <- MCMClogit(fmla, data=gen_data_pass, glm.family="binomial",mcmc=40000,thin=40,burnin=5000)
  gmodel[[i]] <- glm(fmla, data=gen_data_pass, family="binomial");
  beta=model[[i]]                #Posterior sample of the PS model parameters; length= #of iterations
  mat=model.matrix(gmodel[[i]])  #create a design matrix of covariates, length= # of students
  ps_BPSA1 <- matrix(rep(0,nrow(model[[i]])*nrow(gen_data_pass)),nrow=nrow(gen_data_pass))
  
  for(j in 1:nrow(beta)) # jth simulated set of beta => one set of ps
  {
    temp=mat%*%beta[j,]    
    ps_BPSA1[,j] <- exp(temp)/(1+exp(temp))
  }
  bps_all[[i]] <- ps_BPSA1 ## save the posterior distribution of ps for each of the selected models
}

# STEP 3: Sampling from all models posterior distributions from the BMA to obtain the weighted model posterior distribution

bma_ps2 <- matrix(rep(0,nrow(beta)*nrow(gen_data_pass)),nrow=nrow(gen_data_pass))
model_label <- 1:nmodel

# sample weigths 
post_prob <- bma_bus$postprob[1:nmodel]/sum(bma_bus$postprob[1:nmodel])

for (k in 1:nrow(beta))
{
  bma_ps2[,k] <- bps_all[[sample(model_label,1,prob=post_prob)]][,k]
}
```

```{r, eval=TRUE,  include=TRUE}
##### PASSING #######
library(Matching)

# STEP 4: match based on model from STEP 3

# MatchBalance formula

MB_fml <- as.formula(Tr ~ 
                       AGE_ON_FIRST_DAY + 
                       male + 
                       hr_rem + 
                       COLLEGE_READY_MATH + 
                       COLLEGE_READY_ENGLISH + 
                       CB_PCT_COL + 
                       CB_MEDIAN_INCOME + 
                       FIRST_GENERATION_IND + 
                       TERM_CREDITS + 
                       EVER_CONCURRENT_IND)

# 

#### Optimal Matching
# used Matching instead of optmatch library

Y <- gen_data_pass$passed
Tr <- gen_data_pass$bs_deg
m <- 5

optm1=cbind(rep(0,nrow(beta)),rep(0,nrow(beta)))
# matches=cbind(rep(0, length(bma_ps2[,1])*m*length(gen_data_pass$bs_deg[gen_data_pass$bs_deg == 1])), rep(0, length(bma_ps2[,1])*m*length(gen_data_pass$bs_deg[gen_data_pass$bs_deg == 1])))

for(i in 1:nrow(beta))
{
  test=Match(Y=Y, Tr=Tr, X=bma_ps2[,i], ties=F, replace = T, M=m, version = "fast")
  optm1[i,] <- c(test$est, test$se.standard)
  #matches[,i] <- c(test$index.treated, test$index.control)
}

# View(gen_data_pass[test$index.control,])

# STEP 5: estimate the treatment effect

passing_te <- optm1

mean_tr_ef <- mean(passing_te[,1])

tr_ef_passing <- as.data.frame(passing_te)
tr_ef_passing  %>% 
  ggplot((aes(V1))) + 
  geom_histogram(aes(y=..density..), fill = "white", colour = "black") + 
  geom_density(alpha = .2, fill = "#00abe1") + 
  geom_vline(xintercept = 0) +
  geom_vline(xintercept = quantile(tr_ef_passing$V1, probs = .975), linetype="dotted") + 
  geom_vline(xintercept = quantile(tr_ef_passing$V1, probs = .025), linetype="dotted") +
  labs(x = "Estimated Treatment Effect on Passing GPA of Pathways",
       title = "Distribution of Treatment Effect Estimates")
```

```{r, eval=TRUE,  include=TRUE}
##### TERM_GPA #######
# STEP 4: match based on model from STEP 3

#### Optimal Matching
# used Matching instead of optmatch library
Y <- scale(gen_data_pass$TERM_GPA) # TERM_GPA
Tr <- gen_data_pass$bs_deg
m <- 5

optm1=cbind(rep(0,nrow(beta)),rep(0,nrow(beta)))
for(i in 1:nrow(beta))
{
  test=Match(Y=Y, Tr=Tr, X=bma_ps2[,i], ties=F, replace = T, M=m, version = "fast")
  optm1[i,] <- c(test$est, test$se.standard)
}

# STEP 5: estimate the treatment effect

term_gpa_te <- optm1

mean_tr_ef <- mean(term_gpa_te[,1])

tr_ef_term_gpa <- as.data.frame(term_gpa_te)
tr_ef_term_gpa  %>% 
  ggplot() + 
  geom_density(aes(V1)) + 
  geom_vline(xintercept = 0) +
  geom_vline(xintercept = mean_tr_ef, linetype="dotted") + 
  labs(x = "Estimated Treatment Effect on Passing GPA of Pathways",
       title = "Distribution of Treatment Effect Estimates")
```

```{r, eval=TRUE,  include=TRUE}
##### F-S RETENTION #######
# STEP 4: match based on model from STEP 3

#### Optimal Matching
# used Matching instead of optmatch library
Y <- gen_data_pass$FALL_SPRING_RETENTION # F-S RETENTION
Tr <- gen_data_pass$bs_deg
m <- 5

optm1=cbind(rep(0,nrow(beta)),rep(0,nrow(beta)))
for(i in 1:nrow(beta))
{
  test=Match(Y=Y, Tr=Tr, X=bma_ps2[,i], ties=F, replace = T, M=m, version = "fast")
  optm1[i,] <- c(test$est, test$se.standard)
}

# STEP 5: estimate the treatment effect

ret_te <- optm1

mean_tr_ef <- mean(ret_te[,1])

tr_ef_ret <- as.data.frame(ret_te)
tr_ef_ret  %>% 
  ggplot() + 
  geom_density(aes(V1)) + 
  geom_vline(xintercept = 0) +
  labs(x = "Estimated Treatment Effect on Fall-Spring retention of Pathways",
       title = "Distribution of Treatment Effect Estimates")
```

```{r, eval=TRUE,  include=TRUE}
# Credit Momentum

gen_data_pass$credit_mo <- gen_data_pass$TERM_CREDITS
```

```{r, eval=TRUE,  include=TRUE}
# comparison plot of propensity scores between BUS and non-BUS
ps_mean <- rowMeans(bma_ps2)
ps_plot_data <- as.data.frame(cbind(Y, Tr, ps_mean))

ps_plot_data %>% ggplot() + 
  geom_density(aes(x = ps_mean, color = as.factor(Tr))) + 
  labs(title = "Propensity Score comparisons between BUS students and non-BUS students",
       x = "Mean MCMC Propensity Scores by student for both BUS and non-BUS student") + 
  scale_color_discrete(labels = c("non-BUS", "BUS"), name = "")
```

### Frequentist control models

```{r, eval=TRUE,  include=TRUE}
# run glm/lm for all models for baseline analysis
freq_glm_ps <- glm(fmla_bma, data = gen_data_pass)
summary(freq_glm_ps)


Tr <- gen_data_pass$bs_deg
X <- freq_glm_ps$fitted.values

# passed
Y <- gen_data_pass$passed
freq_glm_pass <- Match(Y=Y, Tr=Tr, X=X, ties=F, replace = T)
summary(freq_glm_pass)

# f-s retention
Y <- gen_data_pass$FALL_SPRING_RETENTION
freq_glm_pass <- Match(Y=Y, Tr=Tr, X=X, ties=F, replace = T)
summary(freq_glm_pass)

# term credits

# simple glm models
freq_glm_pass <- glm( passed ~ bs_deg + TERM_CREDITS +
                     AGE_ON_FIRST_DAY +
                     male + 
                     male_age + 
                     hr_rem + 
                     COLLEGE_READY_ENGLISH +
                     COLLEGE_READY_MATH +  
                     TOTAL_CREDITS_EARNED + 
                     FIRST_GENERATION_IND +
                     EVER_CONCURRENT_IND +
                     HIGH_SCHOOL_GPA_AB + 
                     HIGH_SCHOOL_GPA_BC +
                     HIGH_SCHOOL_GPA_CD + 
                     HIGH_SCHOOL_GPA_DF + 
                     CB_PCT_COL + 
                     CB_MEDIAN_INCOME + 
                     col_first_gen,
                    data = gen_data_pass, family = "binomial")

summary(freq_glm_pass)

freq_glm_fsr <- glm( FALL_SPRING_RETENTION ~ bs_deg + TERM_CREDITS +
                     AGE_ON_FIRST_DAY +
                     male + 
                     male_age + 
                     hr_rem + 
                     COLLEGE_READY_ENGLISH +
                     COLLEGE_READY_MATH +  
                     TOTAL_CREDITS_EARNED + 
                     FIRST_GENERATION_IND +
                     EVER_CONCURRENT_IND +
                     HIGH_SCHOOL_GPA_AB + 
                     HIGH_SCHOOL_GPA_BC +
                     HIGH_SCHOOL_GPA_CD + 
                     HIGH_SCHOOL_GPA_DF + 
                     CB_PCT_COL + 
                     CB_MEDIAN_INCOME + 
                     col_first_gen,
                    data = gen_data_pass, family = "binomial")

summary(freq_glm_fsr)
```

### Term Credits model

```{r, eval=TRUE,  include=TRUE}
gen_data_pass <- gen_data %>% 
  mutate(passed = TERM_GPA >= 2) %>%
  filter(cte_nobs == 0) %>%
  filter(wd == 0) %>%
  dplyr::select(bs_deg,
                TERM_CREDITS,
                AGE_ON_FIRST_DAY,
                male, 
                hr_rem, 
                COLLEGE_READY_ENGLISH,
                COLLEGE_READY_MATH,
                TOTAL_CREDITS_EARNED,
                FIRST_GENERATION_IND, 
                EVER_CONCURRENT_IND,
                HIGH_SCHOOL_GPA_AB,
                HIGH_SCHOOL_GPA_BC,
                HIGH_SCHOOL_GPA_CD,
                HIGH_SCHOOL_GPA_DF,
                CB_PCT_COL,
                CB_MEDIAN_INCOME)

gen_data_pass$AGE_ON_FIRST_DAY <- scale(gen_data_pass$AGE_ON_FIRST_DAY)
gen_data_pass$TOTAL_CREDITS_EARNED <- scale(gen_data_pass$TOTAL_CREDITS_EARNED)
gen_data_pass$TERM_CREDITS <- scale(gen_data_pass$TERM_CREDITS)
gen_data_pass$COLLEGE_READY_ENGLISH <- ifelse(gen_data_pass$COLLEGE_READY_ENGLISH == "Y", 1, 0)
gen_data_pass$COLLEGE_READY_MATH <- ifelse(gen_data_pass$COLLEGE_READY_MATH == "Y", 1,  0)
gen_data_pass$CB_MEDIAN_INCOME <- scale(gen_data_pass$CB_MEDIAN_INCOME)
gen_data_pass$male_age <- gen_data_pass$male*gen_data_pass$AGE_ON_FIRST_DAY # interaction variable for age and gender
gen_data_pass$col_first_gen <- gen_data_pass$CB_PCT_COL*gen_data_pass$FIRST_GENERATION_IND # interaction variable for CB percent college and first gen

covar_all <- names(gen_data_pass)
covar <- covar_all[-c(1, 2)] # Term credits should be left in for Passes, TERM_GPA and Retention modeling but should be removed from term_credit modeling obviously

fmla_bma <- as.formula(bs_deg ~ 
                     AGE_ON_FIRST_DAY +
                     male + 
                     male_age +
                     hr_rem + 
                     COLLEGE_READY_ENGLISH +
                     COLLEGE_READY_MATH +  
                     TOTAL_CREDITS_EARNED + 
                     FIRST_GENERATION_IND +
                     EVER_CONCURRENT_IND +
                     HIGH_SCHOOL_GPA_AB + 
                     HIGH_SCHOOL_GPA_BC +
                     HIGH_SCHOOL_GPA_CD + 
                     HIGH_SCHOOL_GPA_DF + 
                     CB_PCT_COL + 
                     CB_MEDIAN_INCOME + 
                     col_first_gen)
```

```{r, eval=TRUE,  include=TRUE}
# STEP 1: select propensity score models with BMA
# Adapted from Cassie (Jianshen) Chen and David Kaplan 2014 r scrpit and paper
# "Bayesian Model Averaging for Propensity Score Analysis"
# BMA model selection
bma_bus <- bic.glm(fmla_bma, data = gen_data_pass, glm.family = "binomial", occam.window = F)

summary(bma_bus)
# imageplot.bma(bma_bus)
```

```{r, eval=TRUE,  include=TRUE}
bma_bus$postprob # posterior predictive probability of each model
cumsum(bma_bus$postprob) # cumulative posterior predivtive probabilities
nmodel <- length(bma_bus$postprob) 
variables <- bma_bus$which # which variables were selected by models for BMA

# STEP 2: all BMA models with MCMClogit: Best  5  models (cumulative posterior probability =  0.6181)
set.seed(1983)
model <- rep(list(1), nmodel)
gmodel <- rep(list(1), nmodel)
bps_all <- rep(list(1), nmodel)
fmla_models <- rep(list(1, nmodel)) # object to hold all the models used for MCMClogit estimation

# for loop for running MCMC models based on BMA output
for (i in 1:nmodel)
{ 
  fmla <- as.formula(paste("bs_deg ~ ", paste(covar[variables[i,]==TRUE], collapse= "+")))
  fmla_models[[i]] <- as.formula(paste("bs_deg ~ ", paste(covar[variables[i,]==TRUE], collapse= "+")))
  model[[i]] <- MCMClogit(fmla, data=gen_data_pass, glm.family="binomial",mcmc=40000,thin=40,burnin=5000)
  gmodel[[i]] <- glm(fmla, data=gen_data_pass, family="binomial");
  beta=model[[i]]                #Posterior sample of the PS model parameters; length= #of iterations
  mat=model.matrix(gmodel[[i]])  #create a design matrix of covariates, length= # of students
  ps_BPSA1 <- matrix(rep(0,nrow(model[[i]])*nrow(gen_data_pass)),nrow=nrow(gen_data_pass))
  
  for(j in 1:nrow(beta)) # jth simulated set of beta => one set of ps
  {
    temp=mat%*%beta[j,]    
    ps_BPSA1[,j] <- exp(temp)/(1+exp(temp))
  }
  bps_all[[i]] <- ps_BPSA1 ## save the posterior distribution of ps for each of the selected models
}

# STEP 3: Sampling from all models posterior distributions from the BMA to obtain the weighted model posterior distribution

bma_ps2 <- matrix(rep(0,nrow(beta)*nrow(gen_data_pass)),nrow=nrow(gen_data_pass))
model_label <- 1:nmodel

# sample weigths 
post_prob <- bma_bus$postprob[1:nmodel]/sum(bma_bus$postprob[1:nmodel])

for (k in 1:nrow(beta))
{
  bma_ps2[,k] <- bps_all[[sample(model_label,1,prob=post_prob)]][,k]
}
```


```{r, eval=TRUE,  include=TRUE}
##### TERM CREDITS #######

# STEP 4: match based on model from STEP 3

# MatchBalance formula

MB_fml <- as.formula(Tr ~ 
                       AGE_ON_FIRST_DAY + 
                       male + 
                       hr_rem + 
                       COLLEGE_READY_MATH + 
                       COLLEGE_READY_ENGLISH + 
                       CB_PCT_COL + 
                       CB_MEDIAN_INCOME + 
                       FIRST_GENERATION_IND + 
                       EVER_CONCURRENT_IND)

# 

#### Optimal Matching
# used Matching instead of optmatch library

Y <- gen_data_pass$TERM_CREDITS
Tr <- gen_data_pass$bs_deg
m <- 5

optm1=cbind(rep(0,nrow(beta)),rep(0,nrow(beta)))
for(i in 1:nrow(beta))
{
  test=Match(Y=Y, Tr=Tr, X=bma_ps2[,i], ties=F, replace = T, M=m, version = "fast")
  optm1[i,] <- c(test$est, test$se.standard)
}

# View(gen_data_pass[test$index.control,])

# STEP 5: estimate the treatment effect

tc_te <- optm1

mean_tr_ef <- mean(tc_te[,1])

tr_ef_tc <- as.data.frame(tc_te)
tr_ef_tc  %>% 
  ggplot() + 
  geom_density(aes(V1)) + 
  geom_vline(xintercept = 0, linetype="dotted") +
  geom_vline(xintercept = mean_tr_ef) + 
  labs(x = "Estimated Treatment Effect on Passing GPA of Pathways",
       title = "Distribution of Treatment Effect Estimates")
```

## Credit Momentum

```{r, eval=TRUE,  include=TRUE}
gen_data_pass <- gen_data %>% 
  mutate(passed = TERM_GPA >= 2) %>%
  filter(cte_nobs == 0) %>%
  filter(wd == 0) %>%
  dplyr::select(bs_deg,
                credits_mo,
                AGE_ON_FIRST_DAY,
                male, 
                hr_rem, 
                COLLEGE_READY_ENGLISH,
                COLLEGE_READY_MATH,
                TOTAL_CREDITS_EARNED,
                FIRST_GENERATION_IND, 
                EVER_CONCURRENT_IND,
                HIGH_SCHOOL_GPA_AB,
                HIGH_SCHOOL_GPA_BC,
                HIGH_SCHOOL_GPA_CD,
                HIGH_SCHOOL_GPA_DF,
                CB_PCT_COL,
                CB_MEDIAN_INCOME)

gen_data_pass$AGE_ON_FIRST_DAY <- scale(gen_data_pass$AGE_ON_FIRST_DAY)
gen_data_pass$TOTAL_CREDITS_EARNED <- scale(gen_data_pass$TOTAL_CREDITS_EARNED)
gen_data_pass$COLLEGE_READY_ENGLISH <- ifelse(gen_data_pass$COLLEGE_READY_ENGLISH == "Y", 1, 0)
gen_data_pass$COLLEGE_READY_MATH <- ifelse(gen_data_pass$COLLEGE_READY_MATH == "Y", 1,  0)
gen_data_pass$CB_MEDIAN_INCOME <- scale(gen_data_pass$CB_MEDIAN_INCOME)
gen_data_pass$male_age <- gen_data_pass$male*gen_data_pass$AGE_ON_FIRST_DAY # interaction variable for age and gender
gen_data_pass$col_first_gen <- gen_data_pass$CB_PCT_COL*gen_data_pass$FIRST_GENERATION_IND # interaction variable for CB percent college and first gen

covar_all <- names(gen_data_pass)
covar <- covar_all[-c(1, 2)] # Term credits should be left in for Passes, TERM_GPA and Retention modeling but should be removed from term_credit modeling obviously

fmla_bma <- as.formula(bs_deg ~ 
                     AGE_ON_FIRST_DAY +
                     male + 
                     male_age +
                     hr_rem + 
                     COLLEGE_READY_ENGLISH +
                     COLLEGE_READY_MATH +  
                     TOTAL_CREDITS_EARNED + 
                     FIRST_GENERATION_IND +
                     EVER_CONCURRENT_IND +
                     HIGH_SCHOOL_GPA_AB + 
                     HIGH_SCHOOL_GPA_BC +
                     HIGH_SCHOOL_GPA_CD + 
                     HIGH_SCHOOL_GPA_DF + 
                     CB_PCT_COL + 
                     CB_MEDIAN_INCOME + 
                     col_first_gen)
```

```{r, eval=TRUE,  include=TRUE}
# STEP 1: select propensity score models with BMA
# Adapted from Cassie (Jianshen) Chen and David Kaplan 2014 r scrpit and paper
# "Bayesian Model Averaging for Propensity Score Analysis"
# BMA model selection
bma_bus <- bic.glm(fmla_bma, data = gen_data_pass, glm.family = "binomial", occam.window = F)

summary(bma_bus)
# imageplot.bma(bma_bus)
```

```{r, eval=TRUE,  include=TRUE}
bma_bus$postprob # posterior predictive probability of each model
cumsum(bma_bus$postprob) # cumulative posterior predivtive probabilities
nmodel <- length(bma_bus$postprob) 
variables <- bma_bus$which # which variables were selected by models for BMA

# STEP 2: all BMA models with MCMClogit: Best  5  models (cumulative posterior probability =  0.6181)
set.seed(1983)
model <- rep(list(1), nmodel)
gmodel <- rep(list(1), nmodel)
bps_all <- rep(list(1), nmodel)
fmla_models <- rep(list(1, nmodel)) # object to hold all the models used for MCMClogit estimation

# for loop for running MCMC models based on BMA output
for (i in 1:nmodel)
{ 
  fmla <- as.formula(paste("bs_deg ~ ", paste(covar[variables[i,]==TRUE], collapse= "+")))
  fmla_models[[i]] <- as.formula(paste("bs_deg ~ ", paste(covar[variables[i,]==TRUE], collapse= "+")))
  model[[i]] <- MCMClogit(fmla, data=gen_data_pass, glm.family="binomial",mcmc=40000,thin=40,burnin=5000)
  gmodel[[i]] <- glm(fmla, data=gen_data_pass, family="binomial");
  beta=model[[i]]                #Posterior sample of the PS model parameters; length= #of iterations
  mat=model.matrix(gmodel[[i]])  #create a design matrix of covariates, length= # of students
  ps_BPSA1 <- matrix(rep(0,nrow(model[[i]])*nrow(gen_data_pass)),nrow=nrow(gen_data_pass))
  
  for(j in 1:nrow(beta)) # jth simulated set of beta => one set of ps
  {
    temp=mat%*%beta[j,]    
    ps_BPSA1[,j] <- exp(temp)/(1+exp(temp))
  }
  bps_all[[i]] <- ps_BPSA1 ## save the posterior distribution of ps for each of the selected models
}

# STEP 3: Sampling from all models posterior distributions from the BMA to obtain the weighted model posterior distribution

bma_ps2 <- matrix(rep(0,nrow(beta)*nrow(gen_data_pass)),nrow=nrow(gen_data_pass))
model_label <- 1:nmodel

# sample weigths 
post_prob <- bma_bus$postprob[1:nmodel]/sum(bma_bus$postprob[1:nmodel])

for (k in 1:nrow(beta))
{
  bma_ps2[,k] <- bps_all[[sample(model_label,1,prob=post_prob)]][,k]
}
```

```{r, eval=TRUE,  include=TRUE}
##### TERM CREDITS #######

# STEP 4: match based on model from STEP 3

# MatchBalance formula

MB_fml <- as.formula(Tr ~ 
                       AGE_ON_FIRST_DAY + 
                       male + 
                       hr_rem + 
                       COLLEGE_READY_MATH + 
                       COLLEGE_READY_ENGLISH + 
                       CB_PCT_COL + 
                       CB_MEDIAN_INCOME + 
                       FIRST_GENERATION_IND + 
                       EVER_CONCURRENT_IND)

# 

#### Optimal Matching
# used Matching instead of optmatch library

Y <- gen_data_pass$credits_mo
Tr <- gen_data_pass$bs_deg
m <- 5

optm1=cbind(rep(0,nrow(beta)),rep(0,nrow(beta)))
for(i in 1:nrow(beta))
{
  test=Match(Y=Y, Tr=Tr, X=bma_ps2[,i], ties=F, replace = T, M=m, version = "fast")
  optm1[i,] <- c(test$est, test$se.standard)
}

# View(gen_data_pass[test$index.control,])

# STEP 5: estimate the treatment effect

tc_te <- optm1

mean_tr_ef <- mean(tc_te[,1])

tr_ef_tc <- as.data.frame(tc_te)
tr_ef_tc  %>% 
  ggplot() + 
  geom_density(aes(V1)) + 
  geom_vline(xintercept = 0) +
  geom_vline(xintercept = mean_tr_ef, linetype="dotted") + 
  labs(x = "Estimated Treatment Effect on 15 credits or more of Pathways",
       title = "Distribution of Treatment Effect Estimates")

# sd_tr_ef <- mean(tc_te[,2])
# tr_ef_tc <- as.data.frame(tc_te)
# tr_ef_tc  %>%
#   ggplot() +
#   geom_density(aes(V2)) +
#   geom_vline(xintercept = sd_tr_ef, linetype="dotted") +
#   labs(x = "Estimated Treatment Effect on 15 credits or more of Pathways",
#        title = "Distribution of Standard Error Estimates")
# 
# tr_ef_tc <- as.data.frame(tc_te)
# tr_ef_tc  %>%
#   ggplot() +
#   geom_density(aes(V1)) +
#   geom_density(aes(V2))

```

## BUS Comparison plots

```{r}
# TERM_GPA
bus_data %>% ggplot() + 
  geom_density(aes(x=TERM_GPA, col = as.factor(TERM_CODE)))
```

```{r}
# TERM_CREDITS
bus_data %>% ggplot() + 
  geom_density(aes(x=TERM_CREDITS, col = as.factor(TERM_CODE)))
```

```{r}
# GENDER
bus_data %>% ggplot() + 
  geom_bar(aes(x=male, fill = as.factor(TERM_CODE)), position = "dodge")
```

```{r}
# ETHNICITY
bus_data %>% ggplot() + 
  geom_bar(aes(x=ETHNICITY, fill = as.factor(TERM_CODE)), position = "dodge") + 
  coord_flip()
```

```{r}
# age
bus_data %>%
  filter(AGE_ON_FIRST_DAY < 41) %>% 
  ggplot() + 
  geom_density(aes(x=AGE_ON_FIRST_DAY, col = as.factor(TERM_CODE)), position = "dodge") 
```

```{r}
# ETHNICITY
bus_data %>% ggplot() + 
  geom_bar(aes(x=HIGH_SCHOOL_GPA, fill = as.factor(TERM_CODE)), position = "dodge") 
```

```{r}
# COLLEGE_READY_MATH
bus_data %>% ggplot() + 
  geom_bar(aes(x=COLLEGE_READY_MATH, fill = as.factor(TERM_CODE)), position = "dodge") 
```

```{r}
# COLLEGE_READY_ENGLISH
bus_data %>% ggplot() + 
  geom_bar(aes(x=COLLEGE_READY_ENGLISH, fill = as.factor(TERM_CODE)), position = "dodge") 
```

```{r}
# CB_MEDIAN_INCOME
bus_data %>% ggplot() + 
  geom_density(aes(x=CB_MEDIAN_INCOME, col = as.factor(TERM_CODE)), position = "dodge") 
```

```{r}
# CB_PCT_COL
bus_data %>% ggplot() + 
  geom_density(aes(x=CB_PCT_COL, col = as.factor(TERM_CODE)), position = "dodge") 
```

```{r}
# FALL_SPRING_RETENTION
bus_data %>% ggplot() + 
  geom_bar(aes(x=FALL_SPRING_RETENTION, fill = as.factor(TERM_CODE)), position = "dodge") 
```

```{r}
# passing gpa
bus_data %>%
  mutate(passed = TERM_GPA >= 2) %>%
  ggplot() + 
  geom_bar(aes(x=passed, fill = as.factor(TERM_CODE)), position = "dodge") 
```

```{r}
# credits_mo
bus_data %>% ggplot() + 
  geom_density(aes(x=TOTAL_CREDITS_EARNED, col = as.factor(TERM_CODE))) 
```

```{r}
# credits_mo
bus_data %>% ggplot() + 
  geom_bar(aes(x=credits_mo, fill = as.factor(TERM_CODE)), position = "dodge") 
```

### Plots for outcome variables BUS

```{r}
# Term GPA
bus_data %>% ggplot() + 
  geom_density(aes(TERM_GPA, color = as.factor(TERM_CODE))) 
```

```{r}
# Term Credits
bus_data %>% ggplot() + 
  geom_density(aes(TERM_CREDITS, color = as.factor(TERM_CODE))) 
```

```{r}
# Passed fall semeseter
bus_data %>% ggplot() + 
  geom_density(aes(passing, color = as.factor(TERM_CODE))) 
```

```{r}
# retained F-S semester
bus_data %>% ggplot() + 
  geom_density(aes(FALL_SPRING_RETENTION, color = as.factor(TERM_CODE))) 
```

```{r}
bus_data %>% ggplot() + 
  geom_density(aes(credits_mo, color = as.factor(TERM_CODE))) 
```

### Raw outcome plots FALL

```{r}
# Term GPA
gen_data %>%
  filter(cte_nobs == 0) %>%
  ggplot() + 
  geom_density(aes(TERM_GPA, color = as.factor(bs_deg))) 
```

```{r}
# Term GPA
gen_data %>% ggplot() + 
  geom_density(aes(TERM_CREDITS, color = as.factor(bs_deg))) 
```

a degree works plan on file?
- academic plan
- success plan

```{r}
# Compared to non-GS first year students FALL 2018
gen_data %>%
  group_by(bs_deg) %>%
  summarise(average_tc = mean(TERM_CREDITS),
            n_dis = n_distinct(PIDM))
```

```{r}
gen_data %>%
  ggplot() + 
  geom_density(aes(TERM_CREDITS, col = as.factor(bs_deg)))
```

```{r}
# Compared to previous BUS students
bus_data %>% 
  group_by(TERM_CODE) %>% 
  summarise(average_tc = mean(TERM_CREDITS),
            n_dis = n_distinct(PIDM))
```

